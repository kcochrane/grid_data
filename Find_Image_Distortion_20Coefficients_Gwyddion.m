%Solves the 20 linear equations to find the 20 cubic distortion
%coefficients (see Gwyddion manual)
%--------------------------------------------------------------------------
%User input:
x_old=[0.03383, 0.43176,0.93976,0.19469,0.52066,0.90801, 0.04441,0.3635,0.69263,0.94452];
x_new=[0.03873, 0.43097,0.93981,0.18208,0.50541,0.89766, 0.03903,0.36236,0.68569,0.94011];
y_old=[0.911494, 0.89037,0.90304,0.227192,0.21874,0.197617, 0.096239,0.089374,0.074587,0.080923];
y_new=[0.912342, 0.888045,0.900428,0.2558896,0.246829,0.222533, 0.100110,0.091050,0.082,0.088187];
%--------------------------------------------------------------------------
syms a00 a01 a02 a03 a10 a20 a30 a11 a12 a21 b00 b01 b02 b03 b10 b20 b30 b11 b12 b21;

    eq_x_1=strcat(num2str(x_old(1),6),'=a00+a01*',num2str(x_new(1),6),'+a02*',num2str(x_new(1)^2,6),'+a03*',num2str(x_new(1)^3,6),...
        '+a10*',num2str(y_new(1),6),'+a20*',num2str((y_new(1)^2),6),'+a30*',num2str((y_new(1)^3),6),...
        '+a11*',num2str(x_new(1)*y_new(1),6),'+a12*',num2str((x_new(1)^2)*y_new(1),6),'+a21*',num2str(x_new(1)*(y_new(1)^2),6));
    eq_x_2=strcat(num2str(x_old(2),6),'=a00+a01*',num2str(x_new(2),6),'+a02*',num2str(x_new(2)^2,6),'+a03*',num2str(x_new(2)^3,6),...
        '+a10*',num2str(y_new(2),6),'+a20*',num2str(y_new(2)^2,6),'+a30*',num2str(y_new(2)^3,6),...
        '+a11*',num2str(x_new(2)*y_new(2),6),'+a12*',num2str((x_new(2)^2)*y_new(2),6),'+a21*',num2str(x_new(2)*(y_new(2)^2),6));
    eq_x_3=strcat(num2str(x_old(3),6),'=a00+a01*',num2str(x_new(3),6),'+a02*',num2str(x_new(3)^2,6),'+a03*',num2str(x_new(3)^3,6),...
        '+a10*',num2str(y_new(3),6),'+a20*',num2str(y_new(3)^2,6),'+a30*',num2str(y_new(3)^3,6),...
        '+a11*',num2str(x_new(3)*y_new(3),6),'+a12*',num2str((x_new(3)^2)*y_new(3),6),'+a21*',num2str(x_new(3)*(y_new(3)^2),6));
    eq_x_4=strcat(num2str(x_old(4),6),'=a00+a01*',num2str(x_new(4),6),'+a02*',num2str(x_new(4)^2,6),'+a03*',num2str(x_new(4)^3,6),...
        '+a10*',num2str(y_new(4),6),'+a20*',num2str(y_new(4)^2,6),'+a30*',num2str(y_new(4)^3,6),...
        '+a11*',num2str(x_new(4)*y_new(4),6),'+a12*',num2str((x_new(4)^2)*y_new(4),6),'+a21*',num2str(x_new(4)*(y_new(4)^2),6));
    eq_x_5=strcat(num2str(x_old(5),6),'=a00+a01*',num2str(x_new(5),6),'+a02*',num2str(x_new(5)^2,6),'+a03*',num2str(x_new(5)^3,6),...
        '+a10*',num2str(y_new(5),6),'+a20*',num2str(y_new(5)^2,6),'+a30*',num2str(y_new(5)^3,6),...
        '+a11*',num2str(x_new(5)*y_new(5),6),'+a12*',num2str((x_new(5)^2)*y_new(5),6),'+a21*',num2str(x_new(5)*(y_new(5)^2),6));
    eq_x_6=strcat(num2str(x_old(6),6),'=a00+a01*',num2str(x_new(6),6),'+a02*',num2str(x_new(6)^2,6),'+a03*',num2str(x_new(6)^3,6),...
        '+a10*',num2str(y_new(6),6),'+a20*',num2str(y_new(6)^2,6),'+a30*',num2str(y_new(6)^3,6),...
        '+a11*',num2str(x_new(6)*y_new(6),6),'+a12*',num2str((x_new(6)^2)*y_new(6),6),'+a21*',num2str(x_new(6)*(y_new(6)^2),6));
    eq_x_7=strcat(num2str(x_old(7),6),'=a00+a01*',num2str(x_new(7),6),'+a02*',num2str(x_new(7)^2,6),'+a03*',num2str(x_new(7)^3,6),...
        '+a10*',num2str(y_new(7),6),'+a20*',num2str(y_new(7)^2,6),'+a30*',num2str(y_new(7)^3,6),...
        '+a11*',num2str(x_new(7)*y_new(7),6),'+a12*',num2str((x_new(7)^2)*y_new(7),6),'+a21*',num2str(x_new(7)*(y_new(7)^2),6));
    eq_x_8=strcat(num2str(x_old(8),6),'=a00+a01*',num2str(x_new(8),6),'+a02*',num2str(x_new(8)^2,6),'+a03*',num2str(x_new(8)^3,6),...
        '+a10*',num2str(y_new(8),6),'+a20*',num2str(y_new(8)^2,6),'+a30*',num2str(y_new(8)^3,6),...
        '+a11*',num2str(x_new(8)*y_new(8),6),'+a12*',num2str((x_new(8)^2)*y_new(8),6),'+a21*',num2str(x_new(8)*(y_new(8)^2),6));
    eq_x_9=strcat(num2str(x_old(9),6),'=a00+a01*',num2str(x_new(9),6),'+a02*',num2str(x_new(9)^2,6),'+a03*',num2str(x_new(9)^3,6),...
        '+a10*',num2str(y_new(9),6),'+a20*',num2str(y_new(9)^2,6),'+a30*',num2str(y_new(9)^3,6),...
        '+a11*',num2str(x_new(9)*y_new(9),6),'+a12*',num2str((x_new(9)^2)*y_new(9),6),'+a21*',num2str(x_new(9)*(y_new(9)^2),6));
    eq_x_10=strcat(num2str(x_old(10),6),'=a00+a01*',num2str(x_new(10),6),'+a02*',num2str(x_new(10)^2,6),'+a03*',num2str(x_new(10)^3,6),...
        '+a10*',num2str(y_new(10),6),'+a20*',num2str(y_new(10)^2,6),'+a30*',num2str(y_new(10)^3,6),...
        '+a11*',num2str(x_new(10)*y_new(10),6),'+a12*',num2str((x_new(10)^2)*y_new(10),6),'+a21*',num2str(x_new(10)*(y_new(10)^2),6));
    
    eq_y_1=strcat(num2str(y_old(1),6),'=b00+b01*',num2str(x_new(1),6),'+b02*',num2str(x_new(1)^2,6),'+b03*',num2str(x_new(1)^3,6),...
        '+b10*',num2str(y_new(1),6),'+b20*',num2str(y_new(1)^2,6),'+b30*',num2str(y_new(1)^3,6),...
        '+b11*',num2str(x_new(1)*y_new(1),6),'+b12*',num2str((x_new(1)^2)*y_new(1),6),'+b21*',num2str(x_new(1)*(y_new(1)^2),6));
    eq_y_2=strcat(num2str(y_old(2),6),'=b00+b01*',num2str(x_new(2),6),'+b02*',num2str(x_new(2)^2,6),'+b03*',num2str(x_new(2)^3,6),...
        '+b10*',num2str(y_new(2),6),'+b20*',num2str(y_new(2)^2,6),'+b30*',num2str(y_new(2)^3,6),...
        '+b11*',num2str(x_new(2)*y_new(2),6),'+b12*',num2str((x_new(2)^2)*y_new(2),6),'+b21*',num2str(x_new(2)*(y_new(2)^2),6));
    eq_y_3=strcat(num2str(y_old(3),6),'=b00+b01*',num2str(x_new(3),6),'+b02*',num2str(x_new(3)^2,6),'+b03*',num2str(x_new(3)^3,6),...
        '+b10*',num2str(y_new(3),6),'+b20*',num2str(y_new(3)^2,6),'+b30*',num2str(y_new(3)^3,6),...
        '+b11*',num2str(x_new(3)*y_new(3),6),'+b12*',num2str((x_new(3)^2)*y_new(3),6),'+b21*',num2str(x_new(3)*(y_new(3)^2),6));
    eq_y_4=strcat(num2str(y_old(4),6),'=b00+b01*',num2str(x_new(4),6),'+b02*',num2str(x_new(4)^2,6),'+b03*',num2str(x_new(4)^3,6),...
        '+b10*',num2str(y_new(4),6),'+b20*',num2str(y_new(4)^2,6),'+b30*',num2str(y_new(4)^3,6),...
        '+b11*',num2str(x_new(4)*y_new(4),6),'+b12*',num2str((x_new(4)^2)*y_new(4),6),'+b21*',num2str(x_new(4)*(y_new(4)^2),6));
    eq_y_5=strcat(num2str(y_old(5),6),'=b00+b01*',num2str(x_new(5),6),'+b02*',num2str(x_new(5)^2,6),'+b03*',num2str(x_new(5)^3,6),...
        '+b10*',num2str(y_new(5),6),'+b20*',num2str(y_new(5)^2,6),'+b30*',num2str(y_new(5)^3,6),...
        '+b11*',num2str(x_new(5)*y_new(5),6),'+b12*',num2str((x_new(5)^2)*y_new(5),6),'+b21*',num2str(x_new(5)*(y_new(5)^2),6));
    eq_y_6=strcat(num2str(y_old(6),6),'=b00+b01*',num2str(x_new(6),6),'+b02*',num2str(x_new(6)^2,6),'+b03*',num2str(x_new(6)^3,6),...
        '+b10*',num2str(y_new(6),6),'+b20*',num2str(y_new(6)^2,6),'+b30*',num2str(y_new(6)^3,6),...
        '+b11*',num2str(x_new(6)*y_new(6),6),'+b12*',num2str((x_new(6)^2)*y_new(6),6),'+b21*',num2str(x_new(6)*(y_new(6)^2),6));
    eq_y_7=strcat(num2str(y_old(7),6),'=b00+b01*',num2str(x_new(7),6),'+b02*',num2str(x_new(7)^2,6),'+b03*',num2str(x_new(7)^3,6),...
        '+b10*',num2str(y_new(7),6),'+b20*',num2str(y_new(7)^2,6),'+b30*',num2str(y_new(7)^3,6),...
        '+b11*',num2str(x_new(7)*y_new(7),6),'+b12*',num2str((x_new(7)^2)*y_new(7),6),'+b21*',num2str(x_new(7)*(y_new(7)^2),6));
    eq_y_8=strcat(num2str(y_old(8),6),'=b00+b01*',num2str(x_new(8),6),'+b02*',num2str(x_new(8)^2,6),'+b03*',num2str(x_new(8)^3,6),...
        '+b10*',num2str(y_new(8),6),'+b20*',num2str(y_new(8)^2,6),'+b30*',num2str(y_new(8)^3,6),...
        '+b11*',num2str(x_new(8)*y_new(8),6),'+b12*',num2str((x_new(8)^2)*y_new(8),6),'+b21*',num2str(x_new(8)*(y_new(8)^2),6));
    eq_y_9=strcat(num2str(y_old(9),6),'=b00+b01*',num2str(x_new(9),6),'+b02*',num2str(x_new(9)^2,6),'+b03*',num2str(x_new(9)^3,6),...
        '+b10*',num2str(y_new(9),6),'+b20*',num2str(y_new(9)^2,6),'+b30*',num2str(y_new(9)^3,6),...
        '+b11*',num2str(x_new(9)*y_new(9),6),'+b12*',num2str((x_new(9)^2)*y_new(9),6),'+b21*',num2str(x_new(9)*(y_new(9)^2),6));
    eq_y_10=strcat(num2str(y_old(10),6),'=b00+b01*',num2str(x_new(10),6),'+b02*',num2str(x_new(10)^2,6),'+b03*',num2str(x_new(10)^3,6),...
        '+b10*',num2str(y_new(10),6),'+b20*',num2str(y_new(10)^2,6),'+b30*',num2str(y_new(10)^3,6),...
        '+b11*',num2str(x_new(10)*y_new(10),6),'+b12*',num2str((x_new(10)^2)*y_new(10),6),'+b21*',num2str(x_new(10)*(y_new(10)^2),6));
    
    S=solve(eq_x_1, eq_x_2,eq_x_3,eq_x_4,eq_x_5,eq_x_6,eq_x_7,eq_x_8,eq_x_9,eq_x_10,...
        eq_y_1,eq_y_2,eq_y_3,eq_y_4,eq_y_5,eq_y_6,eq_y_7,eq_y_8,eq_y_9,eq_y_10);
    
    a00=S.a00
    a01=S.a01
    a02=S.a02
    a03=S.a03
    a10=S.a10
    a20=S.a20
    a30=S.a30
    a11=S.a11
    a12=S.a12
    a21=S.a21
    b00=S.b00
    b01=S. b01
    b02=S.b02
    b03=S.b03
    b10=S.b10
    b20=S.b20
    b30=S.b30
    b11=S.b11
    b12=S.b12
    b21=S.b21
    
